<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Laser Target Trainer</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #111;
  }
  canvas {
    display: block;
    background: #000;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const CAM_W = 1280;
const CAM_H = 720;
let audioUnlocked = false;

// ===== FULLSCREEN RESIZE =====
function resizeCanvas(){
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

// ===== SCALE FACTOR =====
function sx(x){ return x * canvas.width / CAM_W; }
function sy(y){ return y * canvas.height / CAM_H; }

// ===== GAME CONFIG =====
const MAX_BULLETS = 16;
const SHOT_COOLDOWN = 120;
const TARGET_TIME = 15000;

function imageSize(){
    let size = canvas.height * 0.55;

    size = Math.max(480, size);
    size = Math.min(820, size);

    return Math.floor(size);
}

// ===== STATE =====
let phase = 1, subTarget = 2, score = 0, bullets = 0;
let round = 1, MAX_ROUND = 2;
let phaseStart = Date.now();
let lastShot = 0, laserPrev = false;
let moveX = 100, direction = 1;
let ttsPlayed = false;
let lastLaserOn = false;

// ===== LOAD TARGETS =====
const targets = [];
for(let i=1;i<=4;i++){
    const img = new Image();
    img.src = `/static/images/target${i}.png`;
    targets.push(img);
}

// ===== LOAD SOUNDS =====
function fireShot(){
    bullets++;

    if(audioUnlocked){
        hitSound.pause();
        hitSound.currentTime = 0;
        hitSound.play().catch(()=>{});
    }
}

function loadSound(path){
    const a = new Audio(path);
    a.preload = "auto";

    a.addEventListener("error", ()=>{
        console.error("❌ Audio load failed:", path);
    });

    a.addEventListener("canplaythrough", ()=>{
        console.log("✅ Audio loaded:", path);
    });

    return a;
}

const hitSound = loadSound("/static/sounds/hit.mp3");

const resultSounds = {
  "GIOI": loadSound("/static/sounds/result_gioi.mp3"),
  "KHA": loadSound("/static/sounds/result_kha.mp3"),
  "DAT": loadSound("/static/sounds/result_dat.mp3"),
  "KHONG DAT": loadSound("/static/sounds/result_khong_dat.mp3")
};

function unlockAudio() {
    if (audioUnlocked) return;

    const silent = new Audio();
    silent.src = "/static/sounds/hit.mp3"; // dùng file có sẵn
    silent.volume = 0;
    silent.play().then(() => {
        audioUnlocked = true;
        console.log("Audio unlocked");
    }).catch(() => {});
}
document.addEventListener("keydown", unlockAudio, { once: true });
document.addEventListener("mousedown", unlockAudio, { once: true });

// ===== LASER FETCH =====
let laserPos = null;
let laserNow = false;

async function fetchLaser(){
    try {
        const r = await fetch("/laser");
        const d = await r.json();
        laserNow = d.x !== null;
        laserPos = laserNow ? [d.x, d.y] : null;
    } catch {
        laserNow = false;
        laserPos = null;
    }
}
setInterval(fetchLaser, 30);

function checkHit(tx, ty, size){
    if(!laserPos) return false;

    if(laserNow && !lastLaserOn){
        fireShot(); //

        const lx = sx(laserPos[0]);
        const ly = sy(laserPos[1]);

        if(
            lx >= tx &&
            lx <= tx + size &&
            ly >= ty &&
            ly <= ty + size
        ){
            return true;
        }
    }
    return false;
}


// ===== MAIN LOOP =====
function shotFired(){
    return false;
}

function loop(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const now = Date.now();
    const fired = shotFired();
    const SIZE = imageSize();
    let tx=0, ty=0;

    // ===== PHASE 1 =====
    if(phase===1){
        tx = canvas.width/2 - SIZE/2;
        ty = canvas.height/2 - SIZE/2;
        ctx.drawImage(targets[0], tx, ty, SIZE, SIZE);

        if(checkHit(tx, ty, SIZE)){
            score++;
            phase=2; subTarget=2; phaseStart=now;
        }
        if(now-phaseStart>TARGET_TIME){
            phase=2; subTarget=2; phaseStart=now;
        }
    }

    // ===== PHASE 2 =====
    else if(phase===2){
        ty = canvas.height/2 - SIZE/2;
        const gap = canvas.width * 0.18;
        const centerX = canvas.width / 2;

        const tx2 = centerX - gap - SIZE/2;
        const tx3 = centerX + gap - SIZE/2;

        const drawX = subTarget===2 ? tx2 : tx3;
        ctx.drawImage(subTarget===2?targets[1]:targets[2], drawX, ty, SIZE, SIZE);

        if(checkHit(drawX, ty, SIZE)){
            score++;
            if(subTarget===2){
                subTarget=3;
                phaseStart=now;
            } else {
                phase=4;
                phaseStart=now;
            }
        }

        if(subTarget===2 && now-phaseStart>10000){ subTarget=3; phaseStart=now; }
        if(subTarget===3 && now-phaseStart>5000){ phase=4; phaseStart=now; }
    }

    // ===== PHASE 4 =====
    else if(phase===4){
        moveX += direction*8;
        if(moveX<50 || moveX>canvas.width-SIZE-50) direction*=-1;
        ty = canvas.height/2 - SIZE/2;
        ctx.drawImage(targets[3], moveX, ty, SIZE, SIZE);

        if(checkHit(moveX, ty, SIZE)){
            score++;

            if(round < MAX_ROUND){
                round++;
                phase = 1;
                phaseStart = now;
            } else {
                phase = 99;
            }
        }

        if(now - phaseStart > TARGET_TIME){
            if(round < MAX_ROUND){
                round++;
                phase = 1;
                phaseStart = now;
            } else {
                phase = 99;
            }
        }
    }

    // // ===== DRAW LASER (SCALE) =====
    // if(laserPos){
    //     const lx = sx(laserPos[0]);
    //     const ly = sy(laserPos[1]);
    //
    //     ctx.strokeStyle = "yellow";
    //     ctx.lineWidth = 2;
    //     ctx.beginPath();
    //     ctx.arc(lx, ly, 7, 0, Math.PI*2);
    //     ctx.stroke();
    //
    //     ctx.fillStyle = "rgba(255,255,0,0.9)";
    //     ctx.beginPath();
    //     ctx.arc(lx, ly, 3, 0, Math.PI*2);
    //     ctx.fill();
    // }

    // ===== RESULT =====
    if(phase===99){
    ctx.fillStyle="black";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const rank =
        score>=4 ? "GIOI" :
        score===3 ? "KHA" :
        score===2 ? "DAT" : "KHONG DAT";

    // ===== TITLE =====
    ctx.fillStyle="yellow";
    ctx.font="bold 52px Arial";
    ctx.textAlign="center";
    ctx.fillText(`KET QUA: ${rank}`, canvas.width/2, 120);

    // ===== RESULT TABLE =====
    const tableW = 620;
    const rowH = 50;
    const rows = [
        ["ROUND", round.toString()],
        ["SCORE", score.toString()],
        ["SO DAN", `${bullets}/${MAX_BULLETS}`],
        ["XEP LOAI", rank],
    ];

    const tableH = rowH * rows.length;
    const tx = canvas.width/2 - tableW/2;
    const ty = 180;

    // nền
    ctx.fillStyle = "#222";
    ctx.fillRect(tx, ty, tableW, tableH);

    // viền
    ctx.strokeStyle = "yellow";
    ctx.lineWidth = 3;
    ctx.strokeRect(tx, ty, tableW, tableH);

    ctx.font="24px Arial";
    ctx.textAlign="left";

    rows.forEach((r,i)=>{
        const y = ty + i*rowH;

        // line
        ctx.strokeStyle="yellow";
        ctx.lineWidth=1;
        ctx.beginPath();
        ctx.moveTo(tx, y);
        ctx.lineTo(tx+tableW, y);
        ctx.stroke();

        // label
        ctx.fillStyle="white";
        ctx.fillText(r[0], tx+20, y+34);

        // value
        ctx.fillStyle="yellow";
        ctx.fillText(r[1], tx+340, y+34);
    });

    // hint
    ctx.fillStyle="white";
    ctx.font="22px Arial";
    ctx.textAlign="center";
    ctx.fillText("NHAN R DE RESET", canvas.width/2, ty+tableH+60);

    if (!ttsPlayed && audioUnlocked) {
    const snd = resultSounds[rank];
    snd.pause();
    snd.currentTime = 0;
    snd.play().catch(() => {});
    ttsPlayed = true;
}
}

    // ===== HUD =====
    if(phase!==99){
        ctx.fillStyle="lime";
        ctx.font="24px Arial";
        ctx.fillText(`ROUND: ${round}`,20,30);
        ctx.fillText(`SCORE: ${score}`,20,60);
        ctx.fillText(`SHOT: ${bullets}/${MAX_BULLETS}`,20,90);
    }

    lastLaserOn = laserNow;
    requestAnimationFrame(loop);
}
if (!audioUnlocked) {
    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.fillRect(0, canvas.height - 80, canvas.width, 80);

    ctx.fillStyle = "yellow";
    ctx.font = "24px Arial";
    ctx.textAlign = "center";
    ctx.fillText(
        "CLICK CHUOT HOAC NHAN PHIM BAT KY DE BAT AM THANH",
        canvas.width / 2,
        canvas.height - 30
    );
}

// ===== RESET =====
window.addEventListener("keydown",e=>{
    if(e.key==="r" && phase===99){
        score=bullets=0;
        phase=1; subTarget=2; round=1;
        phaseStart=Date.now();
        lastShot=0; laserPrev=false;
        moveX=100; direction=1; ttsPlayed=false;
    }
});

loop();
</script>
</body>
</html>
